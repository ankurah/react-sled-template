name: Prepare Template

on:
    push:
        branches:
            - dev

jobs:
    test:
        name: Build and Test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Add wasm32 target
              run: rustup target add wasm32-unknown-unknown

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2

            - name: Install wasm-pack
              run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

            - name: Build WASM bindings
              run: wasm-pack build wasm-bindings --target web

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install npm dependencies
              working-directory: react-app
              run: npm install

            - name: TypeScript check
              working-directory: react-app
              run: npx tsc --noEmit

            - name: Build React app
              working-directory: react-app
              run: npm run build

    e2e:
        name: E2E Tests
        runs-on: ubuntu-latest
        needs: test
        steps:
            - uses: actions/checkout@v4

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Add wasm32 target
              run: rustup target add wasm32-unknown-unknown

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2

            - name: Install wasm-pack
              run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

            - name: Build WASM bindings
              run: wasm-pack build wasm-bindings --target web

            - name: Build server
              run: cargo build -p ankurah-template-server --release

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install npm dependencies
              working-directory: react-app
              run: npm install

            - name: Install Playwright
              working-directory: react-app
              run: npx playwright install chromium

            - name: Run E2E tests
              working-directory: react-app
              run: npm run test:e2e
              env:
                  CI: true

    promote:
        name: Promote to main
        runs-on: ubuntu-latest
        needs: [test, e2e]
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: dev
                  fetch-depth: 0

            - name: Prepare transformed tree
              run: |
                  set -euo pipefail
                  find react-app -name '*.tsx' -print0 \
                    | while IFS= read -r -d '' file; do \
                        perl -0pi -e 's/\{\{ (.*?:.*?) \}\}/{% raw %}{{$1}}{% endraw %}/gs' "$file"; \
                      done
                  find . -type f -not -path './.git/*' -print0 \
                    | xargs -0 perl -pi -e 's/ankurah-template/{{project-name}}/g'
                  find . -type f -not -path './.git/*' -print0 \
                    | xargs -0 perl -pi -e 's/ankurah_template/{{crate_name}}/g'
                  git log -1 --pretty=%B dev > /tmp/dev-commit-msg
                  rm -rf .github
                  mkdir -p /tmp/prepared
                  rsync -a --delete --exclude '.git/' ./ /tmp/prepared/
                  git reset --hard HEAD
                  git clean -fd

            - name: Update main branch
              run: |
                  set -euo pipefail
                  git fetch origin main || true
                  if git rev-parse --verify origin/main >/dev/null 2>&1; then
                    git checkout -B main origin/main
                  else
                    git checkout -B main
                  fi
                  rsync -a --delete --exclude '.git/' /tmp/prepared/ ./
                  rm -rf .github
                  git config user.name "ankurah-bot"
                  git config user.email "infra@ankurah.dev"
                  git add -A
                  if git diff --cached --quiet; then
                    echo "No changes to commit"
                    exit 0
                  fi
                  git commit -F /tmp/dev-commit-msg
                  git push origin HEAD:main
